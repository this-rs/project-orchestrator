<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Orchestrator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0f1117;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #f1f5f9;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .logo-container {
      position: relative;
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }

    .logo-icon {
      width: 80px;
      height: 80px;
      opacity: 0;
      animation: fadeInScale 0.5s ease-out 0.1s forwards;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #f1f5f9;
      margin-bottom: 4px;
      text-align: center;
      opacity: 0;
      animation: fadeIn 0.4s ease-out 0.4s forwards;
    }

    .subtitle {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 24px;
      text-align: center;
      opacity: 0;
      animation: fadeIn 0.4s ease-out 0.6s forwards;
    }

    /* -- Checklist -- */
    .checklist {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      opacity: 0;
      animation: fadeIn 0.4s ease-out 0.8s forwards;
    }

    .check-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      transition: background 0.3s, border-color 0.3s;
      min-height: 34px;
    }

    .check-item.success {
      border-color: rgba(34, 197, 94, 0.2);
      background: rgba(34, 197, 94, 0.05);
    }

    .check-item.error {
      border-color: rgba(239, 68, 68, 0.2);
      background: rgba(239, 68, 68, 0.05);
    }

    .check-item.warning {
      border-color: rgba(245, 158, 11, 0.2);
      background: rgba(245, 158, 11, 0.05);
    }

    .check-item.skipped {
      border-color: rgba(107, 114, 128, 0.2);
      background: rgba(107, 114, 128, 0.03);
    }

    .check-item.hidden {
      display: none;
    }

    .check-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Spinner for pending state */
    .check-icon .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(99, 102, 241, 0.15);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    .check-icon svg { width: 16px; height: 16px; }

    .check-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .check-label {
      font-size: 13px;
      color: #cbd5e1;
    }

    .check-subtext {
      font-size: 10px;
      color: #64748b;
      line-height: 1.3;
    }

    .check-subtext.error-text {
      color: #f87171;
    }

    .check-action {
      font-size: 11px;
      color: #6366f1;
      text-decoration: none;
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      background: rgba(99, 102, 241, 0.1);
      transition: background 0.2s;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .check-action:hover {
      background: rgba(99, 102, 241, 0.2);
    }

    /* -- Footer actions -- */
    .footer {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      opacity: 0;
      animation: fadeIn 0.4s ease-out 1s forwards;
      text-align: center;
      width: 300px;
    }

    .status-text {
      font-size: 11px;
      color: #475569;
      transition: color 0.3s;
      text-align: center;
      width: 100%;
    }

    .branding {
      font-size: 10px;
      color: #334155;
      letter-spacing: 0.05em;
      margin-top: 4px;
    }

    .btn-continue {
      display: none;
      padding: 6px 20px;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
      background: #6366f1;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-continue:hover { background: #4f46e5; }
    .btn-continue.visible { display: inline-block; }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.85); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <img class="logo-icon" src="data:image/png;base64,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" alt="Project Orchestrator" />
  </div>
  <div class="title">Project Orchestrator</div>
  <div class="subtitle">AI Agent Orchestrator</div>

  <div class="checklist">
    <div class="check-item" id="check-config">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Configuration</span>
      </div>
    </div>
    <div class="check-item" id="check-claude">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Claude Code CLI</span>
      </div>
    </div>
    <div class="check-item" id="check-docker">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Docker Desktop</span>
      </div>
    </div>
    <div class="check-item" id="check-neo4j">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Neo4j</span>
      </div>
    </div>
    <div class="check-item" id="check-meilisearch">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Meilisearch</span>
      </div>
    </div>
    <div class="check-item hidden" id="check-nats">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">NATS</span>
      </div>
    </div>
    <div class="check-item" id="check-backend">
      <div class="check-icon"><div class="spinner"></div></div>
      <div class="check-content">
        <span class="check-label">Backend server</span>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="status-text" id="status">Checking dependencies...</div>
    <button class="btn-continue" id="btn-continue" onclick="continueAnyway()">Continue anyway</button>
    <div class="branding">Freedom From Scratch</div>
  </div>

  <script>
    // ========================================================================
    // SVG icons
    // ========================================================================
    const ICON_OK   = '<svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" fill="#22c55e" opacity="0.15"/><path d="M5 8l2 2 4-4" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    const ICON_FAIL = '<svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" fill="#ef4444" opacity="0.15"/><path d="M6 6l4 4M10 6l-4 4" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/></svg>';
    const ICON_WARN = '<svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" fill="#f59e0b" opacity="0.15"/><path d="M8 5v3M8 10h.01" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/></svg>';
    const ICON_SKIP = '<svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" fill="#6b7280" opacity="0.15"/><path d="M5 8h6" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round"/></svg>';
    const ICON_SPIN = '<div class="spinner"></div>';

    // Download URLs per platform
    const DOCKER_URLS = {
      'macos': 'https://docs.docker.com/desktop/setup/install/mac-install/',
      'linux': 'https://docs.docker.com/desktop/setup/install/linux/',
      'windows': 'https://docs.docker.com/desktop/setup/install/windows-install/',
    };

    let platformOs = 'macos';
    let globalStartTime = Date.now();
    const GLOBAL_TIMEOUT = 120000; // 120s

    // ========================================================================
    // UI helpers
    // ========================================================================

    function setCheck(id, state, subtext, actionHtml) {
      const el = document.getElementById(id);
      if (!el) return;
      const icon = el.querySelector('.check-icon');
      const content = el.querySelector('.check-content');

      // Update state class
      el.className = 'check-item ' + state;

      // Update icon
      if (state === 'success') icon.innerHTML = ICON_OK;
      else if (state === 'error') icon.innerHTML = ICON_FAIL;
      else if (state === 'warning') icon.innerHTML = ICON_WARN;
      else if (state === 'skipped') icon.innerHTML = ICON_SKIP;
      else icon.innerHTML = ICON_SPIN; // pending / spinner

      // Update subtext
      let subtextEl = content.querySelector('.check-subtext');
      if (subtext) {
        if (!subtextEl) {
          subtextEl = document.createElement('span');
          subtextEl.className = 'check-subtext';
          content.appendChild(subtextEl);
        }
        subtextEl.textContent = subtext;
        subtextEl.className = 'check-subtext' + (state === 'error' ? ' error-text' : '');
      } else if (subtextEl) {
        subtextEl.remove();
      }

      // Remove old action if any
      const oldAction = el.querySelector('.check-action');
      if (oldAction) oldAction.remove();

      if (actionHtml) {
        el.insertAdjacentHTML('beforeend', actionHtml);
      }
    }

    function showItem(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
    }

    function hideItem(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    }

    function setStatus(text) {
      document.getElementById('status').textContent = text;
    }

    function openUrl(url) {
      if (window.__TAURI__) {
        window.__TAURI__.core.invoke('open_url', { url }).catch(err => {
          console.error('open_url failed:', err);
        });
      }
    }

    async function invoke(cmd, args) {
      if (window.__TAURI__) {
        return window.__TAURI__.core.invoke(cmd, args || {});
      }
      throw new Error('Tauri not available');
    }

    function isGlobalTimeout() {
      return (Date.now() - globalStartTime) > GLOBAL_TIMEOUT;
    }

    // ========================================================================
    // Main flow
    // ========================================================================

    async function runChecks() {
      globalStartTime = Date.now();
      setStatus('Checking dependencies...');

      try {
        const deps = await invoke('check_dependencies');
        platformOs = deps.os === 'windows' ? 'windows' : deps.os === 'linux' ? 'linux' : 'macos';

        // -- Configuration --
        if (deps.configExists) {
          setCheck('check-config', 'success');
        } else {
          setCheck('check-config', 'warning', 'Will be created by setup wizard');
        }

        // -- Claude Code CLI --
        if (deps.claudeCodeAvailable) {
          setCheck('check-claude', 'success');
        } else {
          setCheck('check-claude', 'warning', 'Chat features require Claude Code CLI',
            `<span class="check-action" onclick="openUrl('https://docs.anthropic.com/en/docs/claude-code/overview')">Install</span>`);
        }

        // -- NATS visibility --
        if (deps.natsEnabled) {
          showItem('check-nats');
        } else {
          hideItem('check-nats');
        }

        // -- Route based on infra_mode --
        if (deps.infraMode === 'external') {
          // External mode: skip Docker, but check service connectivity
          setCheck('check-docker', 'skipped', 'External mode');
          setCheck('check-neo4j', '', 'Checking connectivity...');
          setCheck('check-meilisearch', '', 'Checking connectivity...');
          if (deps.natsEnabled) {
            setCheck('check-nats', '', 'Checking connectivity...');
          }
          setStatus('Checking services...');
          await pollBackendHealthWithServices(deps.natsEnabled);
          return;
        }

        // -- First-time setup (no config yet) --
        if (!deps.setupCompleted) {
          // Backend runs in minimal mode (no DB), skip service checks
          setCheck('check-docker', 'skipped', 'Setup pending');
          setCheck('check-neo4j', 'skipped', 'Setup pending');
          setCheck('check-meilisearch', 'skipped', 'Setup pending');
          if (deps.natsEnabled) {
            setCheck('check-nats', 'skipped', 'Setup pending');
          }
          setStatus('Starting backend (setup mode)...');
          await pollBackendHealth();
          return;
        }

        // -- Docker mode: check Docker status --
        await handleDockerMode(deps);

      } catch (err) {
        console.error('check_dependencies failed:', err);
        // Fallback: skip dep checks and just poll backend
        setCheck('check-config', 'warning');
        setCheck('check-claude', 'warning', 'Could not check');
        setCheck('check-docker', 'warning', 'Could not check');
        setCheck('check-neo4j', 'warning');
        setCheck('check-meilisearch', 'warning');
        setStatus('Starting backend...');
        await pollBackendHealth();
      }
    }

    // ========================================================================
    // Docker mode handling
    // ========================================================================

    async function handleDockerMode(deps) {
      const dockerStatus = deps.dockerStatus; // "running", "installed", "not_installed"

      if (dockerStatus === 'running') {
        setCheck('check-docker', 'success');
        await startServices(deps);

      } else if (dockerStatus === 'installed') {
        // Docker Desktop is installed but daemon is not running
        setCheck('check-docker', 'warning', 'Docker Desktop is not running',
          `<span class="check-action" onclick="invoke('open_docker_desktop').catch(()=>{})">Open</span>`);
        setCheck('check-neo4j', '', 'Waiting for Docker...');
        setCheck('check-meilisearch', '', 'Waiting for Docker...');
        if (deps.natsEnabled) {
          setCheck('check-nats', '', 'Waiting for Docker...');
        }
        setStatus('Please start Docker Desktop');

        // Poll until Docker daemon comes up
        await pollDockerAvailability(deps);

      } else {
        // Docker not installed
        const url = DOCKER_URLS[platformOs] || DOCKER_URLS['macos'];
        setCheck('check-docker', 'error', 'Docker is required to run services',
          `<span class="check-action" onclick="openUrl('${url}')">Install</span>`);
        setCheck('check-neo4j', 'error', 'Requires Docker');
        setCheck('check-meilisearch', 'error', 'Requires Docker');
        if (deps.natsEnabled) {
          setCheck('check-nats', 'error', 'Requires Docker');
        }
        setStatus('Docker is required');
        document.getElementById('btn-continue').classList.add('visible');

        // Still poll in case user installs Docker while splash is shown
        await pollDockerInstall(deps);
      }
    }

    // ========================================================================
    // Poll for Docker daemon availability (installed but not running)
    // ========================================================================

    async function pollDockerAvailability(deps) {
      while (!isGlobalTimeout()) {
        await sleep(3000);
        try {
          const freshDeps = await invoke('check_dependencies');
          if (freshDeps.dockerStatus === 'running') {
            setCheck('check-docker', 'success');
            // Use fresh deps for credentials (may have changed)
            await startServices(freshDeps);
            return;
          }
        } catch (_) { /* continue polling */ }
      }

      // Global timeout reached
      setCheck('check-docker', 'error', 'Docker did not start in time');
      setStatus('Timed out waiting for Docker');
      document.getElementById('btn-continue').classList.add('visible');
    }

    // ========================================================================
    // Poll for Docker installation (not installed)
    // ========================================================================

    async function pollDockerInstall(deps) {
      while (!isGlobalTimeout()) {
        await sleep(5000);
        try {
          const freshDeps = await invoke('check_dependencies');
          if (freshDeps.dockerStatus === 'running') {
            setCheck('check-docker', 'success');
            await startServices(freshDeps);
            return;
          } else if (freshDeps.dockerStatus === 'installed') {
            // User installed Docker but hasn't started it yet
            setCheck('check-docker', 'warning', 'Docker Desktop is not running');
            setStatus('Please start Docker Desktop');
            await pollDockerAvailability(freshDeps);
            return;
          }
        } catch (_) { /* continue polling */ }
      }
    }

    // ========================================================================
    // Start Docker services and poll their health
    // ========================================================================

    async function startServices(deps) {
      setCheck('check-neo4j', '', 'Starting...');
      setCheck('check-meilisearch', '', 'Starting...');
      if (deps.natsEnabled) {
        setCheck('check-nats', '', 'Starting...');
      }
      setStatus('Starting services...');

      // Build config for start_docker_services
      const config = {
        neo4jPassword: deps.neo4jPassword || '',
        meilisearchKey: deps.meilisearchKey || '',
        natsEnabled: deps.natsEnabled,
      };

      try {
        await invoke('start_docker_services', { config });
      } catch (err) {
        console.error('start_docker_services failed:', err);
        setCheck('check-docker', 'error', 'Failed to start services: ' + err);
        setStatus('Service startup failed');
        document.getElementById('btn-continue').classList.add('visible');
        // Still try polling health — services might have started partially
      }

      // Poll individual service health
      await pollServicesHealth(deps.natsEnabled);
    }

    // ========================================================================
    // Poll individual services health
    // ========================================================================

    async function pollServicesHealth(natsEnabled) {
      setStatus('Waiting for services...');
      const serviceStartTime = Date.now();
      const SERVICE_TIMEOUT = 60000; // 60s per-service warning

      let neo4jReady = false;
      let meiliReady = false;
      let natsReady = !natsEnabled; // skip if disabled

      while (!isGlobalTimeout()) {
        try {
          const health = await invoke('check_services_health', { natsEnabled });

          // -- Neo4j --
          if (!neo4jReady) {
            if (health.neo4j === 'healthy') {
              setCheck('check-neo4j', 'success');
              neo4jReady = true;
            } else if (health.neo4j === 'starting' || health.neo4j === 'notrunning') {
              const elapsed = Date.now() - serviceStartTime;
              if (elapsed > SERVICE_TIMEOUT) {
                setCheck('check-neo4j', 'warning', 'Taking longer than expected...');
              } else {
                setCheck('check-neo4j', '', 'Starting...');
              }
            } else if (health.neo4j === 'unhealthy') {
              setCheck('check-neo4j', 'error', 'Unhealthy');
            }
          }

          // -- Meilisearch --
          if (!meiliReady) {
            if (health.meilisearch === 'healthy') {
              setCheck('check-meilisearch', 'success');
              meiliReady = true;
            } else if (health.meilisearch === 'starting' || health.meilisearch === 'notrunning') {
              const elapsed = Date.now() - serviceStartTime;
              if (elapsed > SERVICE_TIMEOUT) {
                setCheck('check-meilisearch', 'warning', 'Taking longer than expected...');
              } else {
                setCheck('check-meilisearch', '', 'Starting...');
              }
            } else if (health.meilisearch === 'unhealthy') {
              setCheck('check-meilisearch', 'error', 'Unhealthy');
            }
          }

          // -- NATS --
          if (natsEnabled && !natsReady) {
            if (health.nats === 'healthy') {
              setCheck('check-nats', 'success');
              natsReady = true;
            } else if (health.nats === 'disabled') {
              setCheck('check-nats', 'skipped', 'Disabled');
              natsReady = true;
            } else if (health.nats === 'starting' || health.nats === 'notrunning') {
              setCheck('check-nats', '', 'Starting...');
            } else if (health.nats === 'unhealthy') {
              setCheck('check-nats', 'error', 'Unhealthy');
            }
          }

          // All services ready?
          if (neo4jReady && meiliReady && natsReady) {
            setStatus('Services ready, starting backend...');
            await pollBackendHealth();
            return;
          }

        } catch (err) {
          console.error('check_services_health error:', err);
        }

        await sleep(2000);
      }

      // Global timeout
      setStatus('Services took too long to start');
      document.getElementById('btn-continue').classList.add('visible');
      // Still poll backend — it might work with partial services
      await pollBackendHealth();
    }

    // ========================================================================
    // Poll backend /health
    // ========================================================================

    async function pollBackendHealth() {
      setCheck('check-backend', '', 'Starting...');
      setStatus('Starting backend...');

      const port = await invoke('get_server_port').catch(() => 6600);

      while (!isGlobalTimeout()) {
        try {
          const health = await invoke('check_health', { port });
          if (health) {
            setCheck('check-backend', 'success');
            setStatus('Ready');

            // Small delay for visual satisfaction
            await sleep(500);
            transitionToMain();
            return;
          }
        } catch (_) { /* not ready yet */ }
        await sleep(200);
      }

      // Global timeout
      setCheck('check-backend', 'error', 'Failed to start within timeout');
      setStatus('Backend did not start in time');
      document.getElementById('btn-continue').classList.add('visible');
    }

    // External mode: poll /health and update service check-items from the response
    async function pollBackendHealthWithServices(natsEnabled) {
      setCheck('check-backend', '', 'Starting...');

      const port = await invoke('get_server_port').catch(() => 6600);

      while (!isGlobalTimeout()) {
        try {
          const health = await invoke('check_health', { port });
          if (health) {
            // Update service statuses from the enriched /health response
            if (health.services) {
              setCheck('check-neo4j',
                health.services.neo4j === 'connected' ? 'success' : 'error',
                health.services.neo4j === 'connected' ? 'Connected' : 'Unreachable');
              setCheck('check-meilisearch',
                health.services.meilisearch === 'connected' ? 'success' : 'error',
                health.services.meilisearch === 'connected' ? 'Connected' : 'Unreachable');
              if (natsEnabled) {
                // NATS status is not in /health yet — mark as skipped for now
                setCheck('check-nats', 'skipped', 'Not checked');
              }
            } else {
              // Fallback for old /health format (no services field)
              setCheck('check-neo4j', 'skipped', 'Status unavailable');
              setCheck('check-meilisearch', 'skipped', 'Status unavailable');
            }

            setCheck('check-backend', 'success');
            setStatus('Ready');
            await sleep(500);
            transitionToMain();
            return;
          }
        } catch (_) { /* not ready yet */ }
        await sleep(500);
      }

      // Global timeout
      setCheck('check-backend', 'error', 'Failed to start within timeout');
      setStatus('Backend did not start in time');
      document.getElementById('btn-continue').classList.add('visible');
    }

    // ========================================================================
    // Transition & utility
    // ========================================================================

    function transitionToMain() {
      // The backend thread in main.rs handles the actual window transition
      // via show_main_window(). This function is intentionally a no-op.
      // The Rust side drives the transition (decision 0218a69c).
    }

    function continueAnyway() {
      setStatus('Waiting for backend...');
      document.getElementById('btn-continue').classList.remove('visible');
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // ========================================================================
    // Start
    // ========================================================================

    if (window.__TAURI__) {
      runChecks();
    } else {
      window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          if (window.__TAURI__) {
            runChecks();
          } else {
            setStatus('Waiting for Tauri...');
            const interval = setInterval(() => {
              if (window.__TAURI__) {
                clearInterval(interval);
                runChecks();
              }
            }, 100);
          }
        }, 100);
      });
    }
  </script>
</body>
</html>
