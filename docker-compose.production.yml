# =============================================================================
# Project Orchestrator — Production Docker Compose
# =============================================================================
#
# All-in-one deployment using the official ghcr.io image.
# No local build required — just configure and run.
#
# Quick start:
#   cp .env.production.example .env
#   # Edit .env to set secure passwords
#   docker compose -f docker-compose.production.yml up -d
#
# Access the UI at http://localhost:8080 (or your configured SERVER_PORT)

services:
  # ---------------------------------------------------------------------------
  # Neo4j — Knowledge graph database
  # ---------------------------------------------------------------------------
  neo4j:
    image: neo4j:5-community
    container_name: orchestrator-neo4j
    restart: unless-stopped
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-change-me-please}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=${NEO4J_HEAP_INIT:-512m}
      - NEO4J_dbms_memory_heap_max__size=${NEO4J_HEAP_MAX:-1G}
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - orchestrator

  # ---------------------------------------------------------------------------
  # MeiliSearch — Semantic search engine
  # ---------------------------------------------------------------------------
  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: orchestrator-meilisearch
    restart: unless-stopped
    ports:
      - "${MEILISEARCH_PORT:-7700}:7700"
    environment:
      - MEILI_MASTER_KEY=${MEILISEARCH_MASTER_KEY:-change-me-please}
      - MEILI_ENV=production
      - MEILI_LOG_LEVEL=INFO
      - MEILI_MAX_INDEXING_MEMORY=${MEILISEARCH_MAX_MEMORY:-512MiB}
    volumes:
      - meilisearch-data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - orchestrator

  # ---------------------------------------------------------------------------
  # NATS — Message broker for inter-process event sync
  # ---------------------------------------------------------------------------
  nats:
    image: nats:2.11-alpine
    container_name: orchestrator-nats
    restart: unless-stopped
    ports:
      - "${NATS_PORT:-4222}:4222"
      - "${NATS_MONITOR_PORT:-8222}:8222"
    command: ["--http_port", "8222", "--jetstream"]
    volumes:
      - nats-data:/data/jetstream
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - orchestrator

  # ---------------------------------------------------------------------------
  # Orchestrator — Backend + Frontend (ghcr.io image)
  # ---------------------------------------------------------------------------
  orchestrator:
    image: ghcr.io/this-rs/project-orchestrator:${ORCHESTRATOR_IMAGE_TAG:-latest}
    container_name: orchestrator-server
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-change-me-please}
      - MEILISEARCH_URL=http://meilisearch:7700
      - MEILISEARCH_KEY=${MEILISEARCH_MASTER_KEY:-change-me-please}
      - RUST_LOG=${RUST_LOG:-info,project_orchestrator=debug}
      - WORKSPACE_PATH=/workspace
      - SERVE_FRONTEND=${SERVE_FRONTEND:-true}
      - FRONTEND_PATH=/app/dist
      - NATS_URL=nats://nats:4222
      # Auth (uncomment and configure as needed)
      # - JWT_SECRET=${JWT_SECRET}
      # - AUTH_FRONTEND_URL=${AUTH_FRONTEND_URL:-http://localhost:8080}
    depends_on:
      neo4j:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      nats:
        condition: service_healthy
    volumes:
      - orchestrator-data:/workspace
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - orchestrator

volumes:
  neo4j-data:
  neo4j-logs:
  meilisearch-data:
  nats-data:
  orchestrator-data:

networks:
  orchestrator:
    driver: bridge
