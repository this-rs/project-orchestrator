name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: orchestrator
  FRONTEND_REPO: this-rs/project-orchestrator-frontend

jobs:
  # ==========================================================================
  # Build frontend - Compile React SPA once, share as artifact
  # ==========================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FRONTEND_REPO }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # ==========================================================================
  # Build matrix - Compile for all target platforms (light variant)
  # ==========================================================================
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            runner: macos-14
            os: macos
            arch: arm64
            use_cross: false

          # macOS Intel
          - target: x86_64-apple-darwin
            runner: macos-13
            os: macos
            arch: x86_64
            use_cross: false

          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            os: linux
            arch: x86_64
            use_cross: true

          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            os: linux
            arch: arm64
            use_cross: true

          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            os: windows
            arch: x86_64
            use_cross: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.target }}"

      - name: Install cross-rs
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (native)
        if: "!matrix.use_cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --target ${{ matrix.target }}

      # --- Package the binary ---

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Package (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          ARCHIVE_NAME="${BINARY_NAME}-${{ steps.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "staging/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "staging/${ARCHIVE_NAME}/"
          if [ -d "queries" ]; then
            cp -r queries "staging/${ARCHIVE_NAME}/"
          fi
          cd staging
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "ARCHIVE=${ARCHIVE_NAME}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $archiveName = "${env:BINARY_NAME}-${version}-windows-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path "staging/${archiveName}"
          Copy-Item "target/${{ matrix.target }}/release/${env:BINARY_NAME}.exe" "staging/${archiveName}/"
          if (Test-Path "queries") {
            Copy-Item -Recurse "queries" "staging/${archiveName}/"
          }
          Compress-Archive -Path "staging/${archiveName}" -DestinationPath "staging/${archiveName}.zip"
          echo "ARCHIVE=${archiveName}.zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE }}
          path: staging/${{ env.ARCHIVE }}
          retention-days: 1

  # ==========================================================================
  # Build full - Compile with embedded frontend (all-in-one binary)
  # ==========================================================================
  build-full:
    name: Build full ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    needs: [build-frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
            os: macos
            arch: arm64
            use_cross: false

          - target: x86_64-apple-darwin
            runner: macos-13
            os: macos
            arch: x86_64
            use_cross: false

          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            os: linux
            arch: x86_64
            use_cross: true

          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            os: linux
            arch: arm64
            use_cross: true

          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            os: windows
            arch: x86_64
            use_cross: false

    steps:
      - uses: actions/checkout@v4

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.target }}"

      - name: Install cross-rs
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build with embedded frontend (native)
        if: "!matrix.use_cross"
        run: cargo build --release --features embedded-frontend --target ${{ matrix.target }}

      - name: Build with embedded frontend (cross)
        if: matrix.use_cross
        run: cross build --release --features embedded-frontend --target ${{ matrix.target }}

      # --- Package the binary ---

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Package (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          ARCHIVE_NAME="${BINARY_NAME}-full-${{ steps.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "staging/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "staging/${ARCHIVE_NAME}/"
          if [ -d "queries" ]; then
            cp -r queries "staging/${ARCHIVE_NAME}/"
          fi
          cd staging
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "ARCHIVE=${ARCHIVE_NAME}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $archiveName = "${env:BINARY_NAME}-full-${version}-windows-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path "staging/${archiveName}"
          Copy-Item "target/${{ matrix.target }}/release/${env:BINARY_NAME}.exe" "staging/${archiveName}/"
          if (Test-Path "queries") {
            Copy-Item -Recurse "queries" "staging/${archiveName}/"
          }
          Compress-Archive -Path "staging/${archiveName}" -DestinationPath "staging/${archiveName}.zip"
          echo "ARCHIVE=${archiveName}.zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE }}
          path: staging/${{ env.ARCHIVE }}
          retention-days: 1

  # ==========================================================================
  # Package Debian - Build .deb packages for Linux targets
  # ==========================================================================
  package-deb:
    name: Package .deb (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
            artifact_os: linux
            artifact_arch: x86_64

          - target: aarch64-unknown-linux-gnu
            arch: arm64
            artifact_os: linux
            artifact_arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ steps.version.outputs.version }}-${{ matrix.artifact_os }}-${{ matrix.artifact_arch }}.tar.gz
          path: artifact/

      - name: Extract binary to target dir
        run: |
          ARCHIVE_NAME="${BINARY_NAME}-${{ steps.version.outputs.version }}-${{ matrix.artifact_os }}-${{ matrix.artifact_arch }}"
          tar xzf "artifact/${ARCHIVE_NAME}.tar.gz" -C artifact/
          mkdir -p "target/release"
          cp "artifact/${ARCHIVE_NAME}/${BINARY_NAME}" "target/release/${BINARY_NAME}"
          # cargo-deb also needs orch and mcp_server â€” rebuild them or copy from archive
          # For now, copy the main binary and let cargo-deb handle what's available
          cp "target/release/${BINARY_NAME}" "target/release/orch" || true
          cp "target/release/${BINARY_NAME}" "target/release/mcp_server" || true
          chmod +x target/release/*

      - name: Build .deb package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Find and upload .deb
        run: |
          DEB_FILE=$(find target/ -name "*.deb" | head -1)
          DEB_NAME=$(basename "$DEB_FILE")
          cp "$DEB_FILE" "$DEB_NAME"
          echo "DEB_NAME=${DEB_NAME}" >> "$GITHUB_ENV"

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEB_NAME }}
          path: ${{ env.DEB_NAME }}
          retention-days: 1

  # ==========================================================================
  # Release - Collect all artifacts and publish GitHub Release
  # ==========================================================================
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build, build-full, package-deb]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts/ -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.deb" \) -exec cp {} release-files/ \;
          echo "=== Release artifacts ==="
          ls -la release-files/

      - name: Generate checksums
        working-directory: release-files
        run: |
          sha256sum * > checksums-sha256.txt
          echo "=== Checksums ==="
          cat checksums-sha256.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Docker - Build and push multi-arch images to ghcr.io
  # ==========================================================================
  docker-publish:
    name: Docker (${{ matrix.variant }})
    runs-on: ubuntu-latest
    needs: [build-frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: full
            include_frontend: "true"
            suffix: ""

          - variant: api-only
            include_frontend: "false"
            suffix: "-api"

    steps:
      - uses: actions/checkout@v4

      - name: Download frontend dist
        if: matrix.include_frontend == 'true'
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Create empty frontend dir
        if: matrix.include_frontend == 'false'
        run: mkdir -p frontend/dist

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          flavor: |
            suffix=${{ matrix.suffix }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ matrix.variant == 'full' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            FRONTEND_SRC=./frontend
            INCLUDE_FRONTEND=${{ matrix.include_frontend }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # Update Homebrew tap - Push new formula after release is published
  # ==========================================================================
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [release]
    if: "!contains(github.ref, '-')"
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download checksums
        run: |
          curl -fsSL "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/checksums-sha256.txt" \
            -o checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Extract SHA256 values
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "macos_arm64=$(grep "orchestrator-full-${VERSION}-macos-arm64.tar.gz" checksums-sha256.txt | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "macos_x86_64=$(grep "orchestrator-full-${VERSION}-macos-x86_64.tar.gz" checksums-sha256.txt | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$(grep "orchestrator-full-${VERSION}-linux-arm64.tar.gz" checksums-sha256.txt | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "linux_x86_64=$(grep "orchestrator-full-${VERSION}-linux-x86_64.tar.gz" checksums-sha256.txt | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Generate updated formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -e "s/VERSION_PLACEHOLDER/${VERSION}/g" \
              -e "s/SHA256_MACOS_ARM64_PLACEHOLDER/${{ steps.sha.outputs.macos_arm64 }}/g" \
              -e "s/SHA256_MACOS_X86_64_PLACEHOLDER/${{ steps.sha.outputs.macos_x86_64 }}/g" \
              -e "s/SHA256_LINUX_ARM64_PLACEHOLDER/${{ steps.sha.outputs.linux_arm64 }}/g" \
              -e "s/SHA256_LINUX_X86_64_PLACEHOLDER/${{ steps.sha.outputs.linux_x86_64 }}/g" \
              packaging/homebrew/project-orchestrator.rb > formula.rb
          cat formula.rb

      - name: Push to Homebrew tap
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        with:
          source_file: formula.rb
          destination_repo: this-rs/homebrew-tap
          destination_folder: Formula
          destination_branch_create: main
          destination_file: project-orchestrator.rb
          user_email: "ci@openclaw.ai"
          user_name: "OpenClaw CI"
          commit_message: "Update project-orchestrator to v${{ steps.version.outputs.version }}"
